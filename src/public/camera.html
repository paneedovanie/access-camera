<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <body>
    <video autoplay style="background-color: gray"></video>
    <button>Start</button>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const constraints = {
        video: {
          width: {
            min: 1280,
            ideal: 1920,
            max: 2560,
          },
          height: {
            min: 720,
            ideal: 1080,
            max: 1440,
          },
        },
      };
      const configuration = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      let index = 0;
      const peerConnections = new Map();

      (async () => {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);

        stream.getTracks().forEach((track) => {
          for (const key in peerConnections) {
            peerConnections[key].addTrack(track, stream);
          }
        });
      })();

      const socket = io({
        query: {
          type: "camera",
        },
      });

      const video = document.querySelector("video");
      const btn = document.querySelector("button");
      btn.onclick = () => {
        video.play();
      };

      peerConnection.addEventListener("icecandidate", (event) => {
        if (event.candidate) {
          socket.emit("new-ice-candidate", event.candidate);
        }
      });

      peerConnection.addEventListener("connectionstatechange", (event) => {
        console.log(event);
        if (peerConnection.connectionState === "connected") {
          console.log("Peers connected!");
        }
      });

      socket.on("connect", () => {
        window.socket = socket;

        socket.on("message", (msg) => {
          console.log("message: " + msg);
        });

        socket.on("offer", async (offer) => {
          const peerConnection = new RTCPeerConnection(configuration);
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(offer)
          );
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          peerConnections.set(index, peerConnection);
          socket.emit("answer", answer);
        });

        socket.on("new-ice-candidate", async (candidate) => {
          if (candidate) {
            try {
              await peerConnection.addIceCandidate(candidate);
            } catch (e) {
              console.error("Error adding received ice candidate", e);
            }
          }
        });
      });
    </script>
  </body>
</html>
